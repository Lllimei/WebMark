{% extends 'base.html' %}

{% load version_selector_form %}
{% load molecule_selector_form %}
{% block title %}Algorithm comparison{% endblock %}

{% block content %}
<div class="d-flex flex-row flex-wrap justify-content-center">
    <div class="p-4">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Select version:</th>
                    <td>{% version_selector_form 'selector1' 'item1_id' versions1 av1 av2.pk %}</td>
                    <td>{% version_selector_form 'selector2' 'item2_id' versions2 av2 av1.pk %}</td>
                </tr>
            </thead>
            <thead>
                <tr>
                    <th>Select molecule:</th>
                    {% if molecule %}
                        <td>{% molecule_selector_form 'selector3' 'item3_id' common_molecules molecule av1.pk av2.pk %}</td>
                    {% else %}
                        <td>No common molecules</td>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th>name</th>
                    <td><a href="{{ a1.get_absolute_url }}">{{ a1.name }}</a></td>
                    <td><a href="{{ a2.get_absolute_url }}">{{ a2.name }}</a></td>
                </tr>
                <tr>
                    <th>type</th>
                    <td>{{ a1.algorithm_type.type_name }}</td>
                    <td>{{ a2.algorithm_type.type_name }}</td>
                </tr>
                <tr>
                    <th>author</th>
                    <td>{{ a1.user.username }}</td>
                    <td>{{ a2.user.username }}</td>
                </tr>
                <tr>
                    <th>molecule</th>
                    <td>{{ metrics1.molecule.name }}</td>
                    <td>{{ metrics2.molecule.name }}</td>
                </tr>
                <tr>
                    <th>iterations</th>
                    <td>{{ metrics1.iterations }}</td>
                    <td>{{ metrics2.iterations }}</td>
                </tr>
                <tr>
                    <th>measurements</th>
                    <td>{{ metrics1.measurements }}</td>
                    <td>{{ metrics2.measurements }}</td>
                </tr>
                <tr>
                    <th>circuit depth</th>
                    <td>{{ metrics1.circuit_depth }}</td>
                    <td>{{ metrics2.circuit_depth }}</td>
                </tr>
                <tr>
                    <th>accuracy</th>
                    <td>{{ metrics1.accuracy }}</td>
                    <td>{{ metrics2.accuracy }}</td>
                </tr>
            </tbody>
        </table>
    </div>
    <div class="d-flex flex-column align-items-center m-auto">
        <div id="chart-div"></div>
        <div id="chart-link-div"></div>
    </div>
    <div class="d-flex flex-column align-items-center m-auto">
        <div id="chart2-div"></div>
        <div id="chart2-link-div"></div>
    </div>
</div>


<!-- parse template variables to JSON so they can be safely accessed in JS code -->
{{ a1.name|json_script:"a1-name" }}
{{ a2.name|json_script:"a2-name" }}
{{ graph_data|json_script:"graph-data"}}
{{ algo_data|json_script:"algo-data"}}

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
    google.charts.load('current', { packages: ['bar', 'corechart', 'line'] });
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        const data = new google.visualization.DataTable();
        const a1Name = JSON.parse(document.getElementById('a1-name').textContent);
        const a2Name = JSON.parse(document.getElementById('a2-name').textContent);
        const graphData = JSON.parse(document.getElementById('graph-data').textContent);
        data.addColumn('number', 'X');
        data.addColumn('number', a1Name);
        data.addColumn('number', a2Name);
        data.addRows(graphData);

        const algoData = JSON.parse(document.getElementById('algo-data').textContent);
        // convert null values to zeros
        const algoDataCleaned = algoData.map(a => a.map(value => value === null ? 0 : value));
        const columnChartData = google.visualization.arrayToDataTable(algoDataCleaned);

        const baseOptions = {
            width: 600,
            height: 480,
        };

        const lineChartOptions = {
            ...baseOptions,
            title: "NOTE: Graphs are a work-in-progress and currently show dummy data",
            hAxis: {
                title: 'Iterations'
            },
            vAxis: {
                title: 'Accuracy'
            }
        };

        const chart = new google.visualization.LineChart(document.getElementById('chart-div'));
        const linkDiv = document.getElementById("chart-link-div");
        google.visualization.events.addListener(chart, 'ready', () => {
            linkDiv.innerHTML = `<a href=${chart.getImageURI()} download=chart>Download as PNG</a>`;
        });

        const chart2 = new google.visualization.ColumnChart(document.getElementById('chart2-div'));
        const link2Div = document.getElementById("chart2-link-div");
        google.visualization.events.addListener(chart2, 'ready', () => {
            link2Div.innerHTML = `<a href=${chart2.getImageURI()} download=chart>Download as PNG</a>`;
        });

        chart.draw(data, lineChartOptions);
        chart2.draw(columnChartData, baseOptions);
    }
</script>
{% endblock %}